<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Нарисуй стрелки времени</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      h1 {
        text-align: center;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }
      td {
        width: 33.33%;
        padding: 20px;
        text-align: center;
        vertical-align: top;
      }
      .time-label {
        margin-top: 10px;
        font-size: 18px;
      }
      svg {
        width: 150px;
        height: 150px;
      }
      #settingsBtn {
        margin: 20px auto;
        display: block;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: white;
        padding: 20px;
        border-radius: 5px;
        max-width: 400px;
        width: 90%;
      }
      .modal-content label {
        display: block;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Нарисуй стрелки времени</h1>
    <button id="settingsBtn">Настройки</button>
    <table id="clock-table"></table>

    <!-- SVG шаблон -->
    <template id="clock-template">
      <svg viewBox="0 0 200 200">
        <circle cx="100" cy="100" r="95" stroke="black" stroke-width="2" fill="white" />
        <g font-size="16" font-family="Arial" text-anchor="middle" dominant-baseline="middle">
          <text x="100" y="20" transform="rotate(0,100,100)">12</text>
          <text x="100" y="20" transform="rotate(30,100,100)">1</text>
          <text x="100" y="20" transform="rotate(60,100,100)">2</text>
          <text x="100" y="20" transform="rotate(90,100,100)">3</text>
          <text x="100" y="20" transform="rotate(120,100,100)">4</text>
          <text x="100" y="20" transform="rotate(150,100,100)">5</text>
          <text x="100" y="20" transform="rotate(180,100,100)">6</text>
          <text x="100" y="20" transform="rotate(210,100,100)">7</text>
          <text x="100" y="20" transform="rotate(240,100,100)">8</text>
          <text x="100" y="20" transform="rotate(270,100,100)">9</text>
          <text x="100" y="20" transform="rotate(300,100,100)">10</text>
          <text x="100" y="20" transform="rotate(330,100,100)">11</text>
        </g>
        <circle cx="100" cy="100" r="3" fill="black" />
      </svg>
    </template>

    <!-- Модальное окно -->
    <div class="modal" id="settingsModal">
      <div class="modal-content">
        <h2>Настройки</h2>
        <label>
          Начало периода:
          <input type="time" id="startTime" />
        </label>
        <label>
          Конец периода:
          <input type="time" id="endTime" />
        </label>
        <label>
          Шаг времени:
          <select id="step">
            <option value="30">Каждые 30 мин</option>
            <option value="15">Каждые 15 мин</option>
            <option value="10">Каждые 10 мин</option>
            <option value="random">Случайно</option>
          </select>
        </label>
        <label>
          <input type="checkbox" id="showDigital" />
          Показывать цифровое время
        </label>
        <button onclick="saveSettings()">Сохранить</button>
        <button onclick="closeModal()">Закрыть</button>
      </div>
    </div>

    <script>
      function openModal() {
        document.getElementById('settingsModal').style.display = 'flex';
      }
      function closeModal() {
        document.getElementById('settingsModal').style.display = 'none';
        generateClocks();
      }

      document.getElementById('settingsBtn').onclick = openModal;

      function saveSettings() {
        const settings = {
          start: document.getElementById('startTime').value || '00:00',
          end: document.getElementById('endTime').value || '23:59',
          step: document.getElementById('step').value,
          showDigital: document.getElementById('showDigital').checked,
        };
        sessionStorage.setItem('clockSettings', JSON.stringify(settings));
        closeModal();
        generateClocks();
      }

      function loadSettings() {
        const defaults = {
          start: '00:00',
          end: '23:59',
          step: '30',
          showDigital: true,
        };
        const saved = JSON.parse(sessionStorage.getItem('clockSettings')) || defaults;
        document.getElementById('startTime').value = saved.start;
        document.getElementById('endTime').value = saved.end;
        document.getElementById('step').value = saved.step;
        document.getElementById('showDigital').checked = saved.showDigital;
        return saved;
      }

      function generateClocks() {
        const { start, end, step, showDigital } = loadSettings();
        const startMinutes = toMinutes(start);
        const endMinutes = toMinutes(end);
        const stepVal = step === 'random' ? 1 : parseInt(step); // 1 минута для random
        let times = [];
        const count = 12;
        const maxAttempts = 1000;
        let attempts = 0;
        const uniqueTimes = new Set();

        // Helper to round down to nearest step
        function roundToStep(mins, step) {
          return mins - (mins % step);
        }

        // Generate all possible valid times in the interval, rounded to step
        let possibleTimes = [];
        if (step !== 'random') {
          for (let t = roundToStep(startMinutes, stepVal); t <= endMinutes; t += stepVal) {
            if (t >= startMinutes && t <= endMinutes) {
              possibleTimes.push(minutesToTime(t));
            }
          }
        }

        if (step === 'random') {
          // Randomly pick unique raw times (no rounding!) from the interval
          while (uniqueTimes.size < Math.min(count, endMinutes - startMinutes + 1) && attempts < maxAttempts) {
            const rnd = startMinutes + Math.floor(Math.random() * (endMinutes - startMinutes + 1));
            uniqueTimes.add(minutesToTime(rnd));
            attempts++;
          }
          times = Array.from(uniqueTimes);
          // If not enough, fill with more random (may repeat)
          while (times.length < count && attempts < maxAttempts) {
            const rnd = startMinutes + Math.floor(Math.random() * (endMinutes - startMinutes + 1));
            times.push(minutesToTime(rnd));
            attempts++;
          }
        } else {
          // For non-random, just shuffle possibleTimes and take up to count
          possibleTimes = possibleTimes.sort(() => Math.random() - 0.5);
          times = possibleTimes.slice(0, count);
          // If not enough, fill with more random (may repeat)
          while (times.length < count && attempts < maxAttempts) {
            const rnd = startMinutes + Math.floor(Math.random() * (endMinutes - startMinutes + 1));
            const rounded = roundToStep(rnd, stepVal);
            if (rounded >= startMinutes && rounded <= endMinutes) {
              times.push(minutesToTime(rounded));
            }
            attempts++;
          }
        }

        times = times.slice(0, count);
        const table = document.getElementById('clock-table');
        table.innerHTML = '';
        const template = document.getElementById('clock-template');

        for (let i = 0; i < times.length; i += 3) {
          const row = document.createElement('tr');
          for (let j = 0; j < 3; j++) {
            const cell = document.createElement('td');
            const svg = template.content.cloneNode(true);
            cell.appendChild(svg);
            if (showDigital && times[i + j]) {
              const label = document.createElement('div');
              label.className = 'time-label';
              label.textContent = times[i + j];
              cell.appendChild(label);
            }
            row.appendChild(cell);
          }
          table.appendChild(row);
        }
      }

      function toMinutes(t) {
        const [h, m] = t.split(':').map(Number);
        return h * 60 + m;
      }

      function minutesToTime(mins) {
        const h = String(Math.floor(mins / 60)).padStart(2, '0');
        const m = String(mins % 60).padStart(2, '0');
        return `${h}:${m}`;
      }

      window.onload = generateClocks;
    </script>
  </body>
</html>
