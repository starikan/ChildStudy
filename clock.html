<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>–¢—Ä–µ–Ω–∞–∂—ë—Ä: —É—á–∏–º—Å—è –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –≤—Ä–µ–º—è –ø–æ —á–∞—Å–∞–º (–∞–Ω–∞–ª–æ–≥–æ–≤—ã–µ —á–∞—Å—ã –¥–ª—è –¥–µ—Ç–µ–π)</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      h1 {
        text-align: center;
        display: inline-block;
        margin: 0 auto;
        vertical-align: middle;
      }
      .header-row {
        width: 100%;
        display: grid;
        grid-template-columns: 1fr auto auto auto;
        align-items: center;
        margin-bottom: 20px;
        gap: 0 8px;
      }
      .header-row h1 {
        justify-self: center;
        margin: 0;
        grid-column: 1 / 2;
      }
      #settingsBtn, #printBtn, #regenBtn {
        justify-self: end;
        margin: 0;
        display: inline-block;
        vertical-align: middle;
        font-size: 28px;
        background: none;
        border: none;
        cursor: pointer;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }
      td {
        width: 33.33%;
        padding: 20px;
        text-align: center;
        vertical-align: top;
      }
      .time-label {
        margin-top: 10px;
        font-size: 18px;
      }
      .time-label-input {
        display: block;
        margin: 10px auto 0 auto;
        width: 120px;
        height: 35px;
        font-size: 25px;
        border-radius: 6px;
        border: 2px solid #888;
        text-align: center;
      }
      svg {
        width: 180px;
        height: 180px;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: white;
        padding: 20px;
        border-radius: 5px;
        max-width: 400px;
        width: 90%;
      }
      .modal-content label {
        display: block;
        margin-top: 10px;
      }
      @media print {
        .header-row button {
          display: none !important;
        }
        body {
          margin: 0;
          padding: 0;
          width: 210mm;
          height: 297mm;
          box-sizing: border-box;
        }
        html, body {
          width: 210mm;
          height: 297mm;
          min-width: 0;
          min-height: 0;
          max-width: 210mm;
          max-height: 297mm;
        }
        table {
          width: 100%;
          page-break-inside: avoid;
        }
        td {
          padding: 8px;
        }
        .modal, #settingsModal {
          display: none !important;
        }
        @page {
          size: A4 portrait;
          margin: 10mm;
        }
      }
    </style>
  </head>
  <body>
    <div class="header-row">
      <h1>–£—á–∏–º—Å—è –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –≤—Ä–µ–º—è –ø–æ —á–∞—Å–∞–º</h1>
      <button id="settingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
      <button id="printBtn" title="–ü–µ—á–∞—Ç—å" aria-label="–ü–µ—á–∞—Ç—å">üñ®Ô∏è</button>
      <button id="regenBtn" title="–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è" aria-label="–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å" style="font-size:28px; background:none; border:none; cursor:pointer;">üîÑ</button>
    </div>
    <table id="clock-table"></table>

    <!-- SVG —à–∞–±–ª–æ–Ω -->
    <!-- <template id="clock-template"> ... </template> -->
    <div id="svg-template-preload" style="display:none"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div class="modal" id="settingsModal">
      <div class="modal-content">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <label>
          –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞:
          <input type="time" id="startTime" />
        </label>
        <label>
          –ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞:
          <input type="time" id="endTime" />
        </label>
        <label>
          –®–∞–≥ –≤—Ä–µ–º–µ–Ω–∏:
          <select id="step">
            <option value="30">–ö–∞–∂–¥—ã–µ 30 –º–∏–Ω</option>
            <option value="15">–ö–∞–∂–¥—ã–µ 15 –º–∏–Ω</option>
            <option value="10">–ö–∞–∂–¥—ã–µ 10 –º–∏–Ω</option>
            <option value="random">–°–ª—É—á–∞–π–Ω–æ</option>
          </select>
        </label>
        <label>
          <input type="checkbox" id="showDigital" />
          –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ü–∏—Ñ—Ä–æ–≤–æ–µ –≤—Ä–µ–º—è
        </label>
        <label>
          <input type="checkbox" id="showAnalog" checked />
          –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞ —á–∞—Å–∞—Ö
        </label>
        <label>
          <input type="checkbox" id="twentyFourClock" />
          24-—á–∞—Å–æ–≤–æ–π —Ü–∏—Ñ–µ—Ä–±–ª–∞—Ç
        </label>
        <label>
          <input type="checkbox" id="ampmMode" />
          12-—á–∞—Å–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç (AM/PM)
        </label>
        <label>
          <input type="checkbox" id="showDayNightIcons" checked />
          –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–∫–æ–Ω–∫–∏ –¥–Ω—è/–Ω–æ—á–∏
        </label>
        <label>
          –°—Ç–æ–ª–±—Ü–æ–≤:
          <input type="number" id="gridCols" min="1" max="5" value="3" style="width:60px;" />
        </label>
        <label>
          –°—Ç—Ä–æ–∫:
          <input type="number" id="gridRows" min="1" max="5" value="4" style="width:60px;" />
        </label>
        <button onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <script>
      function openModal() {
        document.getElementById('settingsModal').style.display = 'flex';
      }
      function closeModal() {
        document.getElementById('settingsModal').style.display = 'none';
        generateClocks();
      }

      document.getElementById('settingsBtn').onclick = openModal;
      document.getElementById('printBtn').onclick = function() { window.print(); };
      document.getElementById('regenBtn').onclick = function() { generateClocks(); };

      function getDefaultGridByDevice() {
  const w = window.innerWidth;
  const h = window.innerHeight;
  // –ú–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–ø–æ—Ä—Ç—Ä–µ—Ç < 600px)
  if (w <= 600 || h <= 600) return {gridCols: 1, gridRows: 1};
  // –ü–ª–∞–Ω—à–µ—Ç—ã (—à–∏—Ä–∏–Ω–∞ < 900px)
  if (w <= 900 || h <= 900) return {gridCols: 2, gridRows: 2};
  // –î–µ—Å–∫—Ç–æ–ø
  return {gridCols: 3, gridRows: 4};
}

      function loadSettings() {
        const deviceGrid = getDefaultGridByDevice();
        const defaults = {
          start: '00:00',
          end: '23:59',
          step: '30',
          showDigital: false,
          showAnalog: true,
          twentyFourClock: false,
          ampmMode: false,
          showDayNightIcons: true,
          gridCols: deviceGrid.gridCols,
          gridRows: deviceGrid.gridRows,
        };
        const saved = JSON.parse(sessionStorage.getItem('clockSettings')) || defaults;
        document.getElementById('startTime').value = saved.start;
        document.getElementById('endTime').value = saved.end;
        document.getElementById('step').value = saved.step;
        document.getElementById('showDigital').checked = saved.showDigital;
        if (document.getElementById('showAnalog'))
          document.getElementById('showAnalog').checked = saved.showAnalog !== false;
        if (document.getElementById('twentyFourClock'))
          document.getElementById('twentyFourClock').checked = saved.twentyFourClock === true;
        if (document.getElementById('ampmMode'))
          document.getElementById('ampmMode').checked = saved.ampmMode === true;
        if (document.getElementById('showDayNightIcons'))
          document.getElementById('showDayNightIcons').checked = saved.showDayNightIcons !== false;
        if (document.getElementById('gridCols'))
          document.getElementById('gridCols').value = saved.gridCols || 3;
        if (document.getElementById('gridRows'))
          document.getElementById('gridRows').value = saved.gridRows || 4;
        return saved;
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ SVG-—à–∞–±–ª–æ–Ω–∞ –∏–∑ —Ñ–∞–π–ª–∞ –∏ –≤—Å—Ç–∞–≤–∫–∞ –≤ preload-div
      function loadSvgTemplate(callback) {
        fetch('clock-template.svg')
          .then(r => r.text())
          .then(svgText => {
            document.getElementById('svg-template-preload').innerHTML = svgText;
            callback();
          });
      }

      function generateClocks() {
        const { start, end, step, showDigital, twentyFourClock, ampmMode, showDayNightIcons, gridCols = 3, gridRows = 4 } = loadSettings();
        const showAnalog = document.getElementById('showAnalog') ? document.getElementById('showAnalog').checked : true;
        const startMinutes = toMinutes(start);
        const endMinutes = toMinutes(end);
        const stepVal = step === 'random' ? 1 : parseInt(step); // 1 –º–∏–Ω—É—Ç–∞ –¥–ª—è random
        let times = [];
        const count = gridCols * gridRows;
        const maxAttempts = 1000;
        let attempts = 0;
        const uniqueTimes = new Set();

        // Helper to round down to nearest step
        function roundToStep(mins, step) {
          return mins - (mins % step);
        }

        // Generate all possible valid times in the interval, rounded to step
        let possibleTimes = [];
        if (step !== 'random') {
          for (let t = roundToStep(startMinutes, stepVal); t <= endMinutes; t += stepVal) {
            if (t >= startMinutes && t <= endMinutes) {
              possibleTimes.push(minutesToTime(t));
            }
          }
        }

        if (step === 'random') {
          // Randomly pick unique raw times (no rounding!) from the interval
          while (uniqueTimes.size < Math.min(count, endMinutes - startMinutes + 1) && attempts < maxAttempts) {
            const rnd = startMinutes + Math.floor(Math.random() * (endMinutes - startMinutes + 1));
            uniqueTimes.add(minutesToTime(rnd));
            attempts++;
          }
          times = Array.from(uniqueTimes);
          // If not enough, fill with more random (may repeat)
          while (times.length < count && attempts < maxAttempts) {
            const rnd = startMinutes + Math.floor(Math.random() * (endMinutes - startMinutes + 1));
            times.push(minutesToTime(rnd));
            attempts++;
          }
        } else {
          // For non-random, just shuffle possibleTimes and take up to count
          possibleTimes = possibleTimes.sort(() => Math.random() - 0.5);
          times = possibleTimes.slice(0, count);
          // If not enough, fill with more random (may repeat)
          while (times.length < count && attempts < maxAttempts) {
            const rnd = startMinutes + Math.floor(Math.random() * (endMinutes - startMinutes + 1));
            const rounded = roundToStep(rnd, stepVal);
            if (rounded >= startMinutes && rounded <= endMinutes) {
              times.push(minutesToTime(rounded));
            }
            attempts++;
          }
        }

        times = times.slice(0, count);
        const table = document.getElementById('clock-table');
        table.innerHTML = '';
        // –ü–æ–ª—É—á–∞–µ–º SVG-—à–∞–±–ª–æ–Ω –∏–∑ preload
        const svgTemplate = document.getElementById('svg-template-preload').firstElementChild;
        for (let i = 0; i < times.length; i += gridCols) {
          const row = document.createElement('tr');
          for (let j = 0; j < gridCols; j++) {
            const cell = document.createElement('td');
            // –ö–ª–æ–Ω–∏—Ä—É–µ–º SVG –∏–∑ preload
            const svg = svgTemplate.cloneNode(true);
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª–∫–∞–º–∏ —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
            if (showAnalog && times[i + j]) {
              const [h, m] = times[i + j].split(':').map(Number);
              setClockHands(svg, h, m, true);
            } else {
              setClockHands(svg, 0, 0, false);
            }
            // –°–∫—Ä—ã—Ç–∏–µ/–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ 24—á —Ü–∏—Ñ—Ä
            const tfGroup = svg.querySelector('.twentyfour-group');
            if (tfGroup) tfGroup.style.display = twentyFourClock ? '' : 'none';

            // --- Day/Night icons logic ---
            setDayNightIcons(svg, times[i + j], showDayNightIcons, ampmMode, showDigital);

            cell.appendChild(svg);
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'time-label time-label-input';
            let placeholder = '___:___';
            if (showDigital && times[i + j]) {
              if (ampmMode) {
                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ 12-—á–∞—Å–æ–≤–æ–π —Å AM/PM
                const [h, m] = times[i + j].split(':').map(Number);
                let hour = h % 12;
                if (hour === 0) hour = 12;
                const ampm = h < 12 ? 'AM' : 'PM';
                placeholder = `${hour.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')} ${ampm}`;
              } else {
                placeholder = times[i + j];
              }
              input.disabled = true; // disable input if digital time is shown
            } else {
              input.disabled = false; // enable input if digital time is hidden
            }
            input.placeholder = placeholder;
            // –ú–∞—Å–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∏ –≤–∏–∑—É–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            input.addEventListener('input', function(e) {
              maskTimeInput(this, ampmMode);
              updateSvgCheck(input, svg, times, i, j, showDigital, ampmMode);
            });
            input.addEventListener('keydown', function(e) {
              // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã, Backspace, Delete, —Å—Ç—Ä–µ–ª–∫–∏, Tab
              if (
                !(
                  (e.key >= '0' && e.key <= '9') ||
                  e.key === 'Backspace' ||
                  e.key === 'Delete' ||
                  e.key === 'ArrowLeft' ||
                  e.key === 'ArrowRight' ||
                  e.key === 'Tab' ||
                  e.key === 'Home' ||
                  e.key === 'End'
                )
              ) {
                e.preventDefault();
              }
            });
            cell.appendChild(input);
            row.appendChild(cell);
          }
          table.appendChild(row);
        }
      }

      // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª–∫–∞–º–∏ –Ω–∞ SVG-—á–∞—Å–∞—Ö
      function setClockHands(svg, h, m, show) {
        const hourHand = svg.querySelector('#clock-hour-hand');
        const minHand = svg.querySelector('#clock-minute-hand');
        if (show) {
          // hour hand
          const hourAngle = ((h % 12) + m / 60) * 30;
          const hourX = 100 + 40 * Math.sin((Math.PI / 180) * hourAngle);
          const hourY = 100 - 40 * Math.cos((Math.PI / 180) * hourAngle);
          if (hourHand) {
            hourHand.setAttribute('x1', '100');
            hourHand.setAttribute('y1', '100');
            hourHand.setAttribute('x2', hourX.toString());
            hourHand.setAttribute('y2', hourY.toString());
            hourHand.style.display = '';
          }
          // minute hand
          const minAngle = m * 6;
          const minX = 100 + 70 * Math.sin((Math.PI / 180) * minAngle);
          const minY = 100 - 70 * Math.cos((Math.PI / 180) * minAngle);
          if (minHand) {
            minHand.setAttribute('x1', '100');
            minHand.setAttribute('y1', '100');
            minHand.setAttribute('x2', minX.toString());
            minHand.setAttribute('y2', minY.toString());
            minHand.style.display = '';
          }
        } else {
          if (hourHand) hourHand.style.display = 'none';
          if (minHand) minHand.style.display = 'none';
        }
      }

      function toMinutes(t) {
        const [h, m] = t.split(':').map(Number);
        return h * 60 + m;
      }

      function minutesToTime(mins) {
        const h = String(Math.floor(mins / 60)).padStart(2, '0');
        const m = String(mins % 60).padStart(2, '0');
        return `${h}:${m}`;
      }

      function saveSettings() {
        const settings = {
          start: document.getElementById('startTime').value || '00:00',
          end: document.getElementById('endTime').value || '23:59',
          step: document.getElementById('step').value,
          showDigital: document.getElementById('showDigital').checked,
          showAnalog: document.getElementById('showAnalog').checked,
          twentyFourClock: document.getElementById('twentyFourClock').checked,
          ampmMode: document.getElementById('ampmMode').checked,
          showDayNightIcons: document.getElementById('showDayNightIcons').checked,
          gridCols: parseInt(document.getElementById('gridCols').value) || 3,
          gridRows: parseInt(document.getElementById('gridRows').value) || 4,
        };
        sessionStorage.setItem('clockSettings', JSON.stringify(settings));
        generateClocks(); // –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
      }

      // LIVE MODE: –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ä–∞–∑—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
      function setupLiveSettings() {
        const ids = [
          'startTime', 'endTime', 'step',
          'showDigital', 'showAnalog', 'twentyFourClock', 'ampmMode', 'showDayNightIcons',
          'gridCols', 'gridRows'
        ];
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.oninput = el.onchange = function() { saveSettings(); };
          }
        });
      }

      // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–µ—Ç–∫—É, –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ —Ä—É—á–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      let gridTouched = false;
function setupGridAutoSwitch() {
  const gridCols = document.getElementById('gridCols');
  const gridRows = document.getElementById('gridRows');
  if (!gridCols || !gridRows) return;
  gridCols.addEventListener('input', () => { gridTouched = true; });
  gridRows.addEventListener('input', () => { gridTouched = true; });
  window.addEventListener('resize', () => {
    if (!gridTouched) {
      const deviceGrid = getDefaultGridByDevice();
      gridCols.value = deviceGrid.gridCols;
      gridRows.value = deviceGrid.gridRows;
      saveSettings();
    }
  });
}

      // –û—á–∏—â–∞–µ–º sessionStorage –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      window.onload = function() {
        sessionStorage.removeItem('clockSettings');
        setupLiveSettings();
        setupGridAutoSwitch();
        loadSvgTemplate(generateClocks);
      };

      // –ú–∞—Å–∫–∞ –¥–ª—è –ø–æ–ª—è –≤—Ä–µ–º–µ–Ω–∏: —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã, –∞–≤—Ç–æ-–¥–≤–æ–µ—Ç–æ—á–∏–µ, –º–∞–∫—Å–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–æ–≤ (–∏–ª–∏ 8 —Å AM/PM)
      function maskTimeInput(input, ampmMode) {
        let v = input.value.replace(/[^0-9]/g, '');
        if (v.length > 4) v = v.slice(0, 4);
        let out = '';
        if (v.length > 0) out += v.slice(0, 2);
        if (v.length > 2) out += ':' + v.slice(2, 4);
        else if (v.length > 2) out += ':';
        input.value = out;
        // –ï—Å–ª–∏ AM/PM —Ä–µ–∂–∏–º, —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤–≤–µ—Å—Ç–∏ –ø—Ä–æ–±–µ–ª –∏ AM/PM
        if (ampmMode && input.value.length === 5 && input._lastLength !== 6) {
          input.value += ' ';
        }
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã
        if (ampmMode && input.value.length > 8) input.value = input.value.slice(0, 8);
        if (!ampmMode && input.value.length > 5) input.value = input.value.slice(0, 5);
        input._lastLength = input.value.length;
      }

      // --- –í–ù–ï generateClocks ---
      function updateSvgCheck(input, svg, times, i, j, showDigital, ampmMode) {
        const svgCheckmark = svg.querySelector('#svg-checkmark');
        const svgCross = svg.querySelector('#svg-cross');
        if (!svgCheckmark || !svgCross) return;
        svgCheckmark.style.display = 'none';
        svgCross.style.display = 'none';
        if (showDigital) return;
        let val = input.value.trim();
        let correct = times[i + j];
        if (ampmMode) {
          const [h, m] = correct.split(':').map(Number);
          let hour = h % 12;
          if (hour === 0) hour = 12;
          const ampm = h < 12 ? 'AM' : 'PM';
          correct = `${hour.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')} ${ampm}`;
          if (val.length === 8) val = val.replace(/\s+/g, ' ').toUpperCase();
          correct = correct.toUpperCase();
        }
        if (val.length === correct.length) {
          if (val === correct) {
            svgCheckmark.style.display = '';
            svgCross.style.display = 'none';
          } else {
            svgCheckmark.style.display = 'none';
            svgCross.style.display = '';
          }
        }
      }

      // --- Day/Night icons logic ---
      function setDayNightIcons(svg, time, showDayNightIcons, ampmMode, showDigital) {
        const svgSun = svg.querySelector('#svg-sun');
        const svgMoon = svg.querySelector('#svg-moon');
        if (svgSun) svgSun.style.display = 'none';
        if (svgMoon) svgMoon.style.display = 'none';
        if (
          showDayNightIcons &&
          time &&
          (ampmMode || !showDigital)
        ) {
          const [h, m] = time.split(':').map(Number);
          if (h < 12) {
            if (svgSun) svgSun.style.display = '';
          } else {
            if (svgMoon) svgMoon.style.display = '';
          }
        }
      }
    </script>
  </body>
</html>
